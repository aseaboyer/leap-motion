<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Sigmar+One' rel='stylesheet' type='text/css'>
<style>
body {
	font-family:'Sigmar One',sans-serif;
	margin:0;
	padding:0;
}
#canvas {
	background-color:#F9CDAD;
	height:100%;
	margin:0;
	padding:0;
	width:100%;
}
#ui-layer {
	position:fixed;
	margin:0;
	padding:0;
	top:0;
	width:100%;
	z-index:2;
}

#logo {
	color:#FE4365;
	display:block;
	font-size:3em;
	line-height:5em;
	margin:0 auto;
	padding:0;
	text-align:center;
	width:30%;
}

.btn {
	background-color:#FC9D9A;
	border:1px solid #FE4365;
	color:#FE4365;
	display:block;
	font-size:1.2em;
	margin:10px auto;
	padding:10px;
	text-align:center;
	width:30%;
}
.btn.hide {
	display:none;
}
.btn:hover {
	background-color:#dbd;
}
</style>
	
</head>
<body>
<canvas id="canvas"></canvas>
<div id='ui-layer'>
	<div id='logo'>Logo</div>
	<div id='clickables'>
		<span class='btn' id='start' data-button='start'>Start</span>
		<span class='btn hide' id='restart' data-button='restart'>Re-Start</span>
		<span class='btn hide' id='resume' data-button='resume'>Resume (P)</span>
		<span class='btn' id='tutorial' data-button='tutorial'>?</span>
	</div>
</div>

<script src="//js.leapmotion.com/0.2.0/leap.min.js"></script>
<script src="js/gameInfo.js"></script>
<script src="js/player.js"></script>
<script src="js/block.js"></script>
<script>
	//Color Palette from: http://www.colourlovers.com/palette/629637/(%E2%97%95%E3%80%9D%E2%97%95)
	
	var blockData = { /* Defaults, relative to screen size. On creation, save as rounded pixels. */
		min: {
			x: 0.02,
			y: 0.05
		},
		max: {
			x: 0.2,
			y: 0.2
		},
		creation: {
			base: 2000, // in seconds - this is how we start
			mod: 0.01, // what portion to reduce (like a %)
		},
	};
	
	var uiLayer = document.getElementById( "ui-layer" );
	var startBTN = document.getElementById( "start" );
	var restartBTN = document.getElementById( "restart" );
	var resumeBTN = document.getElementById( "resume" );
	var tutorialBTN = document.getElementById( "tutorial" );
	
	var player = new Player();
	var game = new GameInfo( uiLayer, startBTN, restartBTN, resumeBTN );
	//game.time.set();
	game.pause( player.score );
	
	startBTN.addEventListener("click", function(){
		init( canvas.width, canvas.height );
		game.block.set( blockData.creation.base, blockData.creation.mod );
		game.togglePause( player.score );
	}, false);
	restartBTN.addEventListener("click", function(){
		init( canvas.width, canvas.height );
		game.block.set( blockData.creation.base, blockData.creation.mod );
		game.togglePause( player.score );
	}, false);
	resumeBTN.addEventListener("click", function(){
		game.togglePause( player.score );
	}, false);
	document.addEventListener("keydown", function( e ){
		if( e.keyCode == 80 ) {
			game.togglePause();
			game.toggleButtons( player.score );
		}
	}, false);
	tutorialBTN.addEventListener("click", function(){
		console.log( "show player how to play panel" );
	}, false);
	
	// Get the canvas DOM element 
	var canvas = document.getElementById('canvas');
	
	// Making sure we have the proper aspect ratio for our canvas
	canvas.width = canvas.clientWidth;
	canvas.height = canvas.clientHeight;

	// Create the context we will use for drawing
	var c =  canvas.getContext('2d');

	// Save the canvas width and canvas height
	// as easily accesible variables
	var width = canvas.width;
	var height = canvas.height;

	function spawnBlock () {									/**** @andymakesthings - Work from here next ****/
		var modifiers = {
			minX: canvas.width * blockData.min.x, // pick random x+y dims in a range
			maxX: canvas.width * blockData.max.x, // pick random x+y dims in a range
			minY: canvas.height * blockData.min.y, // pick random x+y dims in a range
			maxY: canvas.height * blockData.max.y, // pick random x+y dims in a range
		};
		
		var x = Math.floor((Math.random() * modifiers.maxX) + modifiers.minX);
		var y = Math.floor((Math.random() * modifiers.maxY) + modifiers.minY);
		var speed = (x * y * 2) * 0.005;
		var start = Math.floor((Math.random() * modifiers.maxY) + modifiers.minY); // pick a random x value to start along the top
		
		// at the end, create a new interval that spawns a block? Figure out the best way to do this...
		var newBlock = new Block();
			newBlock.set( x, y, start, speed );
		
		return newBlock;
	}
	
	
	/*
	The leapToScene function takes a position in leap space 
	and converts it to the space in the canvas.

	It does this by using the interaction box, in order to 
	make sure that every part of the canvas is accesible 
	in the interaction area of the leap
	*/
	function leapToScene( frame , leapPos ){

		// Gets the interaction box of the current frame
		var iBox = frame.interactionBox;

		// Gets the left border and top border of the box
		// In order to convert the position to the proper
		// location for the canvas
		var left = iBox.center[0] - iBox.size[0]/2;
		var top = iBox.center[1] + iBox.size[1]/2;

		// Takes our leap coordinates, and changes them so
		// that the origin is in the top left corner 
		var x = leapPos[0] - left;
		var y = leapPos[1] - top;

		// Divides the position by the size of the box
		// so that x and y values will range from 0 to 1
		// as they lay within the interaction box
		x /= iBox.size[0];
		y /= iBox.size[1];

		// Uses the height and width of the canvas to scale
		// the x and y coordinates in a way that they 
		// take up the entire canvas
		x *= width;
		y *= height;

		// Returns the values, making sure to negate the sign 
		// of the y coordinate, because the y basis in canvas 
		// points down instead of up
		return [ x , -y ];

	}
	
	// Creates our Leap Controller
	var controller = new Leap.Controller();
	var blocks = [];
	blocks.push( spawnBlock() ); // create a block
	var leapData = new Array();
	
	// Tells the controller what to do every time it sees a frame - Functionally the Game Update function
	controller.on( 'frame' , function( frame ){
		leapData = frame;
	});
		
	function update( data ) {
		var needsBlock = game.time.update();
		if( needsBlock ) {
			blocks.push( spawnBlock() ); // create a new block
		}
		
		if( blocks.length > 0) {
			for( var i=0; i < blocks.length; i++ ){ // draw blocks
				var isAlive = blocks[i].update( game.time.delta, height );
				if( !isAlive ) {
					player.score++;
					blocks.splice( i, 1 );
					i--;
				}
			}
		}
		
		var hands = [];
		if( data.hands.length >= 2 ) {
			for( var i=0; i < data.hands.length; i++ ){
				hands.push( leapToScene( data, data.hands[i].palmPosition ) );
			}
			
		}
		
		player.update( c, hands, game.time.delta );
		
		if( game.paused ) {
			c.fillStyle = 'rgba(0, 0, 0, 0.2)';
			c.fillRect( 0 , 0 , width , height );
		}
	}
		
	function draw( canv, data ) {
		c.clearRect( 0 , 0 , width , height );
		
		player.orb.draw( canv, player.score ); /**** @andymakesthings - Work from here next ****/
		
		if( blocks.length > 0) {
			for( var i=0; i < blocks.length; i++ ){ // draw blocks
				blocks[i].draw( canv );
			}
		}
		
		var hands = [];
		if( data.hands.length >= 2 ) {
			for( var i=0; i < data.hands.length; i++ ){
				var hand = data.hands[i];
				var handPos = leapToScene( data , hand.palmPosition );
				hands.push( handPos );
				
				canv.fillStyle = "#FC9D9A"; // Setting up the style for the fill
				canv.beginPath(); // Creating the path for the hand circle
				canv.arc(handPos[0], handPos[1], 40, 0, Math.PI*2); // Draw a full circle of radius 10 at the hand position

				canv.closePath();
				canv.fill();
			}
			
		}
	}
		
	function init( w, h ) {
		player.resetScore();
		player.orb.setPosition( (w * 0.5), (h * 0.5) );
		
		animate();
	}
	function animate() {
		requestAnimationFrame( animate );
		
		if( !game.paused ) {
			
			update( leapData );
			draw( c, leapData );
		}
	}
	
	controller.connect();	// Get frames rolling by connecting the controller
	
	init( canvas.width, canvas.height );
	
	
</script>
</body>
</html>